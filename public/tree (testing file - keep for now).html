<!-------------------------------------------------------------------- 
  
   Module: Agglomerative clustering example 
  
   Author: Mike Chantler
  
   What it does:
	Plots topic similarity data as matrix
	Performs agglomerative clustering and outputs linkage table
  
 
   Version history
  	v001	15/08/2018	mjc	Created.


  
----------------------------------------------------------------------> 

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>bidirectional interaction</title>
	<script type="text/javascript" src="d3/d3.v4.js"></script>
	<meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="js/treeUpdate.js"></script> 
	<script src="js/helperFunctions.js"></script>
    <script src="js/packLayout.js"></script>
    <script src="js/sunburst.js"></script>
    <link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="mikeCSS/general.css"/>
	<link rel="stylesheet" type="text/css" href="mikeCSS/simMatrix-v001.css"/>
	<link rel="stylesheet" type="text/css" href="mikeCSS/table-v001.css"/>
</head>

<body>
<div id=treeDiv></div>	
<div id=sunburstDiv></div>	
<div id=packDiv></div>	

<script type="text/javascript">
"use strict"

var tree = tree('#treeDiv');
var sun = sunburst("sunburstDiv");
var pack = packLayout("packDiv");

pack.setGraphs(tree, sun);
sun.setGraphs(tree, pack);
tree.setGraphs(pack, sun);
//=============== READ DATA FILES ================================


d3.queue()
	.defer(d3.csv, "data/topics/REF2014T30TopicOrder.csv")
	.defer(d3.csv, "data/290183_REF_Contextual_table_1314_0.csv")
	.defer(d3.csv, "data/learning-providers-plus.csv")
	.defer(d3.json, "data/topics/REF2014T30Python.json")
	.defer(d3.csv, "data/Towns_List.csv")
	.defer(d3.csv, "data/REF2014_Results.csv")
	.await(initialiseApp)

function initialiseApp(error, ref14data, ref14context , learningProviders, jsonTopicData, townList, stars){
	var towns = {};
	townList.forEach(function(d) {
		towns[d["Town"].toUpperCase()] = [d["Country"]];
	})

	var treeData  = {};
	var eng = [];
	var scot = [];
	var ni = [];
	var wales = [];
	var engTowns = [];
	var scotTowns = [];
	var walesTowns = [];
	var niTowns = [];

	learningProviders.forEach(function(d) {
		if (towns[d["TOWN"].toUpperCase()]) {
			if (towns[d["TOWN"].toUpperCase()] == "England") {
				engTowns.push(d["TOWN"].toUpperCase());
				eng.push(d);
			} else if (towns[d["TOWN"].toUpperCase()] == "Scotland") {
				scotTowns.push(d["TOWN"].toUpperCase());
				scot.push(d);
			} else if (towns[d["TOWN"].toUpperCase()] == "Wales") {
				walesTowns.push(d["TOWN"].toUpperCase());
				wales.push(d);
			} else if (towns[d["TOWN"].toUpperCase()] == "Northern Ireland") {
				niTowns.push(d["TOWN"].toUpperCase());
				ni.push(d)
			} else {
				console.log("nope");
			}
		}
	}) 

	var json = new Object();
	json.name = "Countries";
	json.children = [];

	var data = createDataSet(eng, "England", engTowns, stars);
	json.children.push(data);

	data = createDataSet(scot, "Scotland", scotTowns, stars);
	json.children.push(data);

	data = createDataSet(wales, "Wales", walesTowns, stars);
	json.children.push(data);

	data = createDataSet(ni, "Northern Ireland",niTowns, stars);
	json.children.push(data);
	pack.loadAndRenderDataset(json);
	tree.loadAndRenderDataset(json);
	sun.loadAndRenderDataset(json);
}		

function createTree() {
	var data = createDataSet();
	tree.loadAndRenderDataset(data);
}

var obj = {};
var jsonTree = {}

function changeNodes(expandNode) {
	if(expandNode.children[0].name.substring(0,4) == "node") {
		expandNode.children[0] = obj[expandNode.children[0].name];
		changeNodes(expandNode.children[0])
	}

	if(expandNode.children[1].name.substring(0,4) == "node") {
		expandNode.children[1] = obj[expandNode.children[1].name];
		changeNodes(expandNode.children[1])
	}
}

function createDataSet(eng, name, uniTowns, stars) {
	var json = new Object();
	json.name = name;
	json.children = [];
	var jsonHold = {};

	for (var i in uniTowns) {
		jsonHold[uniTowns[i]] = uniTowns[i];
	}

	var childNodes = {};
	for (var k in jsonHold) {
		if (jsonHold.hasOwnProperty(k)) {  
			var child = new Object();
			child.name = k.toLowerCase();
			childNodes[child.name] = []
			child.children = childNodes[k.toLowerCase()];

			json.children.push(child);
		}
	}

	var uniNodes = {};
	for (var j in eng) {
		if(childNodes[eng[j]["TOWN"].toLowerCase()]) {
			var child = new Object();
			child.name = eng[j]["VIEW_NAME"];
			uniNodes[eng[j]["UKPRN"]] = [];
			child.children = uniNodes[eng[j]["UKPRN"]];

			childNodes[eng[j]["TOWN"].toLowerCase()].push(child);
		}
	}

	var unique = {};
	stars.forEach(function(d) {
		//starDict[d["Institution code (UKPRN)"]] = d;
		if (uniNodes[d["Institution code (UKPRN)"]]) {
			if (!unique[d["Institution code (UKPRN)"]]) {
				unique[d["Institution code (UKPRN)"]] = 1;

				var child = new Object();
				child.name = "stars";

				var one = new Object();
				var two = new Object();
				var three = new Object();
				var four = new Object();

				one.name = "1*";
				one.children = [];
				two.name = "2*";
				two.children = [];
				three.name = "3*";
				three.children = [];
				four.name = "4*";
				four.children = [];

				var oneStar = new Object();
				oneStar.name = parseInt(d["1*"]);

				var twoStar = new Object();
				twoStar.name = parseInt(d["2*"]);

				var threeStar = new Object();
				threeStar.name = parseInt(d["3*"]);

				var fourStar = new Object();
				fourStar.name = parseInt(d["4*"]);

				one.children.push(oneStar);
				two.children.push(twoStar);
				three.children.push(threeStar);
				four.children.push(fourStar);

				oneStar.size = parseInt(d["1*"]);
				twoStar.size = parseInt(d["2*"]);
				threeStar.size= parseInt(d["3*"]);
				fourStar.size = parseInt(d["4*"]);
				child.children = [one, two, three, four];

				uniNodes[d["Institution code (UKPRN)"]].push(child);
			}
		}
	})

	json.children.splice(4);
	/*var unique = {}
	for (var key in starDict) {

		if (!unique[key]) {
			unique[key] = 1;

			var one = new Object();
			child.name = "stars";
			child.children = [starDict[key]["1*"], starDict[key]["2*"], starDict[key]["3*"], starDict[key]["4*"]];
			console.log(child.children);
			if (uniNodes[key]) {
				uniNodes[key].push(child);
			}
		}
	}*/

	return json
}

/*function createDataSet(eng, scot, wales, ni, uniTowns, stars) {
	var json = new Object();
	json.name = "England";
	json.children = [];
	var jsonHold = {};

	for (var i in uniTowns) {
		jsonHold[uniTowns[i]] = uniTowns[i];
	}

	var childNodes = {};
	for (var k in jsonHold) {
		if (jsonHold.hasOwnProperty(k)) {  
			var child = new Object();
			child.name = k.toLowerCase();
			childNodes[child.name] = []
			child.children = childNodes[k.toLowerCase()];

			json.children.push(child);
		}
	}

	var uniNodes = {};
	for (var j in eng) {
		if(childNodes[eng[j]["TOWN"].toLowerCase()]) {
			var child = new Object();
			child.name = eng[j]["VIEW_NAME"];
			uniNodes[eng[j]["UKPRN"]] = [];
			child.children = uniNodes[eng[j]["UKPRN"]];

			childNodes[eng[j]["TOWN"].toLowerCase()].push(child);
		}
	}

	var unique = {};
	stars.forEach(function(d) {
		//starDict[d["Institution code (UKPRN)"]] = d;
		if (uniNodes[d["Institution code (UKPRN)"]]) {
			if (!unique[d["Institution code (UKPRN)"]]) {
				unique[d["Institution code (UKPRN)"]] = 1;

				var child = new Object();
				child.name = "stars";

				var one = new Object();
				var two = new Object();
				var three = new Object();
				var four = new Object();

				one.name = "1*";
				one.children = [];
				two.name = "2*";
				two.children = [];
				three.name = "3*";
				three.children = [];
				four.name = "4*";
				four.children = [];

				var oneStar = new Object();
				oneStar.name = parseInt(d["1*"]);

				var twoStar = new Object();
				twoStar.name = parseInt(d["2*"]);

				var threeStar = new Object();
				threeStar.name = parseInt(d["3*"]);

				var fourStar = new Object();
				fourStar.name = parseInt(d["4*"]);

				one.children.push(oneStar);
				two.children.push(twoStar);
				three.children.push(threeStar);
				four.children.push(fourStar);

				oneStar.size = parseInt(d["1*"]);
				twoStar.size = parseInt(d["2*"]);
				threeStar.size= parseInt(d["3*"]);
				fourStar.size = parseInt(d["4*"]);
				child.children = [one, two, three, four];

				uniNodes[d["Institution code (UKPRN)"]].push(child);
			}
		}
	})

		json.children.splice(10);
		console.log(JSON.stringify(json));

	/*var unique = {}
	for (var key in starDict) {

		if (!unique[key]) {
			unique[key] = 1;

			var one = new Object();
			child.name = "stars";
			child.children = [starDict[key]["1*"], starDict[key]["2*"], starDict[key]["3*"], starDict[key]["4*"]];
			console.log(child.children);
			if (uniNodes[key]) {
				uniNodes[key].push(child);
			}
		}
	}*/

	/*return json
}*/


var dataSet = []
var keys = []

function convertData(d){
	var json = new Object();
	json.name = d.nodeIndex;
	json.children = []

	var child1 = new Object();
	child1.name = d.similarity.xCat;
	child1.size = d.children[0];

	var child2 = new Object();
	child2.name = d.similarity.yCat;
	child2.size = d.children[1];

	json.children.push(child1);
	json.children.push(child2);

	return json
}

</script>
</body>
</html>